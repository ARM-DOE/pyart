<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&lt;no title&gt; &mdash; Py-ART 1.11.7.dev+27a8022 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Py-ART
          </a>
              <div class="version">
                1.11.7.dev+27a8022
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../API/index.html">API Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Moment correction examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html#mapping-examples">Mapping examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html#plotting-examples">Plotting examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../INSTALL.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setting_up_an_environment.html">Setting up an Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributors_guide.html">Contributorâ€™s Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Downloads</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://anaconda.org/conda-forge/arm_pyart">Anaconda Cloud</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/ARM-DOE/pyart">GitHub Repo</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/ARM-DOE/pyart/archive/master.zip">Zip File of Repository</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Notebooks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="basic_ingest_using_test_radar_object.html">Creating a basic ingest of a NetCDF file</a></li>
<li class="toctree-l1"><a class="reference internal" href="changing_fields_and_saving.html">Field manipulation and Saving the Radar Object to a file.</a></li>
<li class="toctree-l1"><a class="reference internal" href="dealiasing_velocity.html">Dealiasing Velocity</a></li>
<li class="toctree-l1"><a class="reference internal" href="mapping_data_to_a_cartesian_grid.html">Mapping Data to a Cartesian Grid</a></li>
<li class="toctree-l1"><a class="reference internal" href="masking_data_with_gatefilters.html">Masking Data With Py-ART Gatefilters</a></li>
<li class="toctree-l1"><a class="reference internal" href="the_pyart_radar_object_and_indexing.html">The Py-ART Radar object and indexing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Help</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/ARM-DOE/pyart/issues">GitHub Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://groups.google.com/forum/#!forum/pyart-users">Mailing List</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Science Lead</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://www.anl.gov/profile/scott-m-collis">Scott Collis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Py-ART</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/differential_phase_proceesing_using_LP_methods.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<center><p><img alt="picture alt" src="http://www.arm.gov/images/template/logo.png" /> #Using linear programming to do phase processing# Scott Collis</p>
<p>ARM Precipitation Sensitive Radar Translator</p>
<p><em>Argonne National Laboratory, Argonne, IL</em></p>
<p>Scott Giangrande</p>
<p>Meteorologist</p>
<p><em>Brookhaven National Laboratory, Brookhaven, NY</em></p>
<p>Import system libraries and append py-art path. import pyart</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>basedir=&#39;/Users/scollis/local_modules/&#39;
import sys
sys.path.append(basedir)
from pyart.io import py_mdv, radar
from pyart.correct import cband
from time import time
from itertools import groupby
import scipy.integrate
from scipy.interpolate import interp1d
from pyart.graph import rayplot, radar_display
from pyart.correct import phase_proc
import copy
import numpy as np
import pylab
import glpk
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>reload(radar)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;module &#39;pyart.io.radar&#39; from &#39;/Users/scollis/local_modules/pyart/io/radar.pyc&#39;&gt;
</pre></div></div>
</div>
<p>Read in the MDV file</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>#sample_file_name=&#39;/data/sample_sapr_data/235545.mdv&#39;
el,az=(1,241)
sample_file_name=&#39;/data/095636.mdv&#39;
my_mdv_object=py_mdv.read_mdv(sample_file_name, debug=True)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Opening  /data/095636.mdv
Getting master header
getting field headers
getting vlevel headers
getting chunk headers
Reading Chunks
Calculating Radar coordinates
Making usable time objects
Calculating cartesian coordinates
indexing fields
</pre></div></div>
</div>
<p>Now we convert the Py-MDV object to a Py-Radar object. This will help keep the code generic.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>myradar=radar.Radar(my_mdv_object)
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Doing  KDP_F
go
Doing  WIDTH_F
go
Doing  DBZ_F
go
Doing  PHIDP_F
go
Doing  ZDR_F
go
Doing  RHOHV_F
go
Doing  NCP_F
go
Doing  VEL_F
go
</pre></div></div>
</div>
<p>Unfold phase.. Note the deepcopy otherwise it is a link and not a independant copy</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>min_phidp=0.01; min_ncp=0.5; min_rhv=0.8; fzl=4000.0
my_unf=phase_proc.get_phidp_unf(myradar, ncp_lev=0.5, rhohv_lev=0.7, ncpts=2, doc=None)
#No docking the end of the coverage. This comes later
my_new_ph=copy.deepcopy(myradar.fields[&#39;dp_phase_shift&#39;])
my_unf[:,-1]=my_unf[:,-2]
my_new_ph[&#39;data&#39;]=my_unf
myradar.fields.update({&#39;unf_dp_phase_shift&#39;:my_new_ph})
</pre></div>
</div>
</div>
<p>Now we create some conditional fields which will be used in the construction of the constraints</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>is_low_z=myradar.fields[&#39;reflectivity_horizontal&#39;][&#39;data&#39;] &lt;10.0
is_high_z=myradar.fields[&#39;reflectivity_horizontal&#39;][&#39;data&#39;] &gt;53.0
z_mod=copy.deepcopy(myradar.fields[&#39;reflectivity_horizontal&#39;][&#39;data&#39;])
z_mod[np.where(is_high_z)]=53.0
z_mod[np.where(is_low_z)]=10.0
#z_mod=z_mod
not_coherent=myradar.fields[&#39;norm_coherent_power&#39;][&#39;data&#39;] &lt; min_ncp
not_correlated=myradar.fields[&#39;copol_coeff&#39;][&#39;data&#39;] &lt; min_rhv
phidp_mod=copy.deepcopy(myradar.fields[&#39;unf_dp_phase_shift&#39;][&#39;data&#39;])
phidp_neg=phidp_mod &lt; min_phidp
phidp_mod[np.where(phidp_neg)]=min_phidp
phidp_mod=phidp_mod
</pre></div>
</div>
</div>
<p>Ok, What do we want here? We have the A matrix which is the block matrix given by:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\bf{A}=\begin{bmatrix} \bf{I} &amp; \bf{-I} \\\\ \bf{-I}&amp; \bf{I} \\\\ \bf{Z} &amp; \bf{M} \end{bmatrix}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\bf{I}\)</span> is the identity matrix, <span class="math notranslate nohighlight">\(\bf{Z}\)</span> is a matrix of zeros and <span class="math notranslate nohighlight">\(\bf{M}\)</span> contains our differential constraints. Each block is of shape n_gates by n_gates making shape(<span class="math notranslate nohighlight">\(\bf{A}\)</span>)=(3<em>n, 2</em>n).</p>
<p>Note that <span class="math notranslate nohighlight">\(\bf{M}\)</span> contains some side padding to deal with edge issues</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>def construct_A_matrix(radar):
    n_gates=len(radar.range[&#39;data&#39;])
    Identity=eye(n_gates)
    St_Gorlv_differential_5pts=[-.2, -.1, 0, .1, .2]
    filt=St_Gorlv_differential_5pts
    filter_length=len(filt)
    M_matrix_middle=np.diag(ones(n_gates-filter_length+1), k=0)*0.0
    posn=np.linspace(-1.0*(filter_length-1)/2, (filter_length-1)/2, filter_length)
    for diag in range(filter_length):
        M_matrix_middle=M_matrix_middle+np.diag(ones(n_gates-filter_length+1 - np.abs(posn[diag])), k=posn[diag])*filt[diag]
    side_pad=(filter_length-1)/2
    M_matrix=np.bmat([np.zeros([n_gates-filter_length+1, side_pad], dtype=float),
        M_matrix_middle,
        np.zeros([n_gates-filter_length+1, side_pad], dtype=float)])
    Z_matrix=zeros([n_gates-filter_length+1, n_gates])
    return np.bmat([[Identity, -1.0*Identity], [Identity, Identity], [Z_matrix, M_matrix]])
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>A_Matrix=construct_A_matrix(myradar)
print A_Matrix.shape
print (A_Matrix.shape[0]/float(len(myradar.range[&#39;data&#39;])), A_Matrix.shape[1]/float(len(myradar.range[&#39;data&#39;])))
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(2945, 1966)
(2.995930824008138, 2.0)
</pre></div></div>
</div>
<p>Ok, now is where we have to get clever. <span class="math notranslate nohighlight">\(\bf{A}\)</span> is constant for the radar (the radar object pads gates with _Fill_Value, making the time-range array rectangular). But the B vector of the objective constraints is not as it contains reflectivity info. Now we want to use Scientific Python array based processing to take advantage of the optimized code backend. The B vector is the negatibe and positive modified unfolded <span class="math notranslate nohighlight">\(\phi_{DP}\)</span> and the self consistency constraint which uses converts
<span class="math notranslate nohighlight">\(Z\)</span> to <span class="math notranslate nohighlight">\(K_{DP}\)</span> and integrates to give a <span class="math notranslate nohighlight">\(\phi_{DP}\)</span> like field.</p>
<p><span class="math notranslate nohighlight">\(\bf{B}=\begin{bmatrix} -\bf{\phi_{DP}} \\\\ \bf{\phi_{DP}} \\\\ \bf{\eta} \end{bmatrix}\)</span></p>
<p>Now we want to array-ize this effectively making <span class="math notranslate nohighlight">\(\bf{B}\)</span> a matrix consiting of:</p>
<p><span class="math notranslate nohighlight">\(\bf{B_{mat}}=\begin{bmatrix} -\bf{\phi_{DP}^{(1)}} &amp; \cdots &amp; -\bf{\phi_{DP}^{(n)}} \\\\ \bf{\phi_{DP}^{(1)}} &amp; \cdots &amp; \bf{\phi_{DP}^{(n)}} \\\\ \bf{\eta}^{(1)} &amp; \cdots &amp; \bf{\eta}^{(n)} \end{bmatrix}\)</span></p>
<p>where n is the number of rays.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>St_Gorlv_differential_5pts=[-.2, -.1, 0, .1, .2]
filt=St_Gorlv_differential_5pts
n_gates=len(myradar.range[&#39;data&#39;])
n_rays=phidp_mod.shape[0]
filter_length=len(filt)
side_pad=(filter_length-1)/2
print &quot;Side pad: &quot;, side_pad
top_of_B_vectors=np.bmat([[-phidp_mod,phidp_mod]])
print top_of_B_vectors.shape, phidp_mod.shape, 360.0*17.0
data_edges=np.bmat([phidp_mod[:, 0:side_pad], np.zeros([n_rays, n_gates-filter_length+1]), phidp_mod[:,-side_pad:]])
print data_edges.shape
ii=filter_length-1
jj=data_edges.shape[1]-1
list_corrl=np.zeros([n_rays, jj-ii+1])
print len(list_corrl)
for count in range(list_corrl.shape[1]):
    list_corrl[:, count]= -1.0*(array(filt)*(np.asarray(data_edges))[:, count:count+ii+1]).sum(axis=1)
print list_corrl.shape

#list_corrl=np.zeros(jj-ii+1)
#for count in range(len(list_corrl)):
#    list_corrl[count]= -1.0*(array(SG_df5)*np.squeeze(np.asarray(data_edges))[count:count+ii+1]).sum()
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Side pad:  2
(6120, 1966) (6120, 983) 6120.0
(6120, 983)
6120
(6120, 979)
</pre></div></div>
</div>
<p>Now for the self consistency constraint.. We are going want a gradient in <span class="math notranslate nohighlight">\(\phi_{DP}\)</span> consistent with <span class="math notranslate nohighlight">\(Z_{dB}\)</span> according to:</p>
<p><span class="math notranslate nohighlight">\(\eta=\frac{(10^{0.1*Z_{dB}})^{0.914}}{w}\)</span></p>
<p>where <span class="math notranslate nohighlight">\(w\)</span> is the (inverse) weight, and is determined by trail and error, and in our case is set to 50,000</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>sct=(((10.0**(0.1*z_mod))**0.914)/60000.0)[:, side_pad:-side_pad]
sct[np.where(sct &lt;0.0)]=0.0
sct[:, 0:side_pad]=list_corrl[:, 0:side_pad]
sct[:, -side_pad:]=list_corrl[:, -side_pad:]
print top_of_B_vectors.shape
print sct.shape
B_vectors=np.bmat([[top_of_B_vectors,sct]])
print B_vectors.shape
print A_Matrix.shape
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(6120, 1966)
(6120, 979)
(6120, 2945)
(2945, 1966)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>weights=np.zeros(my_new_ph[&#39;data&#39;].shape)
phidp_neg=my_new_ph[&#39;data&#39;] &lt;min_phidp
my_new_ph[&#39;data&#39;][np.where(phidp_neg)]=min_phidp
#not_coh=my_ncp[el,az, 0:fzl_e] &lt; min_ncp
#not_cor=my_rhv[el,az, 0:fzl_e] &lt; min_rhv
#need to impliment these up to the FZL
is_garbage=np.logical_or( not_coherent, not_correlated)
m=np.where(is_garbage)
weights[m]=1.0
print weights.shape
nw=np.bmat([weights, np.zeros(weights.shape)])
print nw.shape, B_vectors.shape, A_Matrix.shape
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(6120, 983)
(6120, 1966) (6120, 2945) (2945, 1966)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>raynum=330
mysoln=zeros(phidp_mod.shape)

from time import time
import glpk
           # Import the GLPK module
t0=time()
lp = glpk.LPX()        # Create empty problem instance
lp.name = &#39;LP_MIN&#39;     # Assign symbolic name to problem
lp.obj.maximize = False # Set this as a maximization problem
#lp.rows.add(2*n)         # Append rows
lp.rows.add(2*n_gates+n_gates-4)# Append rows
lp.cols.add(2*n_gates)

glpk.env.term_on = True

for cur_row in range(2*n_gates+n_gates-4):
    lp.rows[cur_row].matrix=list(np.squeeze(np.asarray(A_Matrix[cur_row, :])))
for i in range(2*n_gates):
    lp.cols[i].bounds = 0.0, None

for raynum in range(360):
    this_soln=zeros(phidp_mod.shape[1])
    #print &quot;Doing&quot;, raynum
    for i in range(2*n_gates+n_gates-4):
        lp.rows[i].bounds = B_vectors[raynum, i], None
    for i in range(2*n_gates):
        #lp.cols[i].bounds = 0.0, None
        lp.obj[i]=nw[raynum,i]
    lp.simplex(msg_lev=glpk.LPX.MSG_ON, meth=glpk.LPX.PRIMAL, it_lim=7000, presolve=True)
    for i in range(n_gates):
        this_soln[i]=lp.cols[i+n_gates].primal
    mysoln[raynum, :]=cband.smooth_and_trim(this_soln, window_len=5, window=&#39;sg_smooth&#39;)
<br/><br/><br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>proc_ph=copy.deepcopy(myradar.fields[&#39;dp_phase_shift&#39;])
proc_ph[&#39;data&#39;]=mysoln
proc_ph[&#39;valid_min&#39;]=0.0
proc_ph[&#39;valid_max&#39;]=400.0

myradar.fields.update({&#39;proc_dp_phase_shift&#39;:proc_ph})
kdp=zeros(mysoln.shape)
for i in range(mysoln.shape[0]):
    kdp[i,:]=cband.sobel(mysoln[i, :], window_len=35)/((myradar.range[&#39;data&#39;][1]-myradar.range[&#39;data&#39;][0])/1000.0)

sob_kdp=copy.deepcopy(myradar.fields[&#39;diff_phase&#39;])
sob_kdp[&#39;data&#39;]=kdp
sob_kdp[&#39;valid_min&#39;]=0.0
sob_kdp[&#39;valid_max&#39;]=20.0

myradar.fields.update({&#39;recalculated_diff_phase&#39;:sob_kdp})
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>d_az,d_el=190,0
f=figure(figsize=[10,5])
plot(myradar.fields[&#39;proc_dp_phase_shift&#39;][&#39;data&#39;][d_az+360*d_el, :],&#39;b-&#39;,label=&#39;LP&#39;)
plot(myradar.fields[&#39;unf_dp_phase_shift&#39;][&#39;data&#39;][d_az+360*d_el, :],&#39;g-&#39;, label=&#39;raw&#39;)
ylim([0,290])
twinx()
#plot(z_mod, &#39;r-&#39;, label=&#39;z&#39;)
#xlim([500,1000])
#cband.KDP(mysoln, my_mdv_object.range_km[1]-my_mdv_object.range_km[0], 30)
plot(myradar.fields[&#39;recalculated_diff_phase&#39;][&#39;data&#39;][d_az+360*d_el, :], &#39;r-&#39;)
#plot(z_mod/10)
gca().yaxis.grid(color=&#39;gray&#39;, linestyle=&#39;dashed&#39;)
f=figure()
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_differential_phase_proceesing_using_LP_methods_22_0.png" src="../_images/notebooks_differential_phase_proceesing_using_LP_methods_22_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.figure.Figure at 0x10c953e10&gt;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>my_display=radar_display.radar_display(myradar)
f=figure(figsize=[15,5])
subplot(1,2,1)
my_display.plot_ppi(&#39;proc_dp_phase_shift&#39;, 0)
my_display.append_x()
my_display.append_y()
gca().set_title(my_display.generate_title(&#39;proc_dp_phase_shift&#39;, 0))
my_display.add_cb()
subplot(1,2,2)
my_display.plot_ppi(&#39;recalculated_diff_phase&#39;, 0)
gca().set_title(my_display.generate_title(&#39;recalculated_diff_phase&#39;, 0))
my_display.append_x()
my_display.add_cb()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_differential_phase_proceesing_using_LP_methods_23_0.png" src="../_images/notebooks_differential_phase_proceesing_using_LP_methods_23_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>reload(rayplot)
myrayplot=rayplot.rayplot(myradar, figsize=[15,15])
myrayplot([0,190],myradar.fields.keys())
myrayplot.fig.subplots_adjust(wspace=1.0)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_differential_phase_proceesing_using_LP_methods_24_0.png" src="../_images/notebooks_differential_phase_proceesing_using_LP_methods_24_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2020, Py-ART developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-221367849-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-221367849-1', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>